<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Required - LatticeRT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .disclaimer {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .disclaimer h3 {
            color: #856404;
            margin-top: 0;
        }

        .jotform-container {
            margin: 20px 0;
            min-height: 600px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .footer a {
            color: #3498db;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .offline-registration {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .qr-container {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: inline-block;
        }

        .qr-container img {
            max-width: 200px;
            height: auto;
            border: 1px solid #ccc;
        }

        .qr-link {
            font-family: monospace;
            font-size: 0.9em;
            color: #666;
            word-break: break-all;
            margin: 10px 0;
        }

        .token-entry {
            margin-top: 20px;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 6px;
        }

        .token-entry label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .token-entry input {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }

        .token-entry button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }

        .token-entry button:hover {
            background-color: #218838;
        }

        .online-registration {
            display: block;
        }

        .connection-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .connection-status.online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>LatticeRT</h1>

        <!-- Connection Status Indicator -->
        <div id="connectionStatus" class="connection-status">
            Checking connection...
        </div>

        <!-- Retry Connection Button (hidden by default) -->
        <div id="retryConnection" style="display: none; text-align: center; margin-bottom: 20px;">
            <button onclick="checkConnectionAndSetMode()"
                style="background-color: #17a2b8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                üîÑ Retry Connection Test
            </button>
            <p style="font-size: 0.9em; color: #666; margin: 5px 0 0 0;">Click if you've gained internet access</p>
        </div>

        <div class="disclaimer">
            <h3>‚ö†Ô∏è Important Notice</h3>
            <p><strong>Research only. Not validated for clinical use.</strong></p>
            <p>By proceeding, you acknowledge that:</p>
            <ul>
                <li>LatticeRT is for research/education, not diagnosis or treatment planning</li>
                <li>You must review and verify any exported DICOM content</li>
                <li>You will comply with the Varian Limited Use Software License Agreement</li>
            </ul>
        </div>

        <!-- Online Registration Section -->
        <div id="onlineRegistration" class="online-registration">
            <h2>Registration Required</h2>
            <p>To access LatticeRT, please complete the registration form below. This helps us track usage and ensure
                compliance with the software license agreement.</p>

            <!-- China Access Message -->
            <div
                style="background-color: #e8f4fd; border: 1px solid #b6e0fe; border-radius: 4px; padding: 15px; margin-bottom: 20px; color: #0c5460;">
                <p style="margin-top: 0; font-weight: bold;"> Registration for China Users / ‰∏≠ÂõΩÂ§ßÈôÜÁî®Êà∑Ê≥®ÂÜåËØ¥Êòé</p>
                <p><strong>‰∏≠ÂõΩÂ§ßÈôÜÁî®Êà∑:</strong> Â¶ÇÊûúÊÇ®Êó†Ê≥ïÁúãÂà∞‰∏ãÈù¢ÁöÑÊ≥®ÂÜåË°®Ê†º, ËØ∑ÂèëÈÄÅÊÇ®ÁöÑÂßìÂêçÂíåÂåªÈô¢/Â≠¶Ê†°ÂêçÁß∞ÂèäÂú∞ÂùÄÂà∞ <a
                        href="mailto:maas.team@varian.com">maas.team@varian.com</a>, Êàë‰ª¨Â∞ÜÂ∞ΩÂø´‰ª•ÈÇÆ‰ª∂ÂΩ¢ÂºèÂèëÈÄÅÊÇ®ÁöÑÊ≥®ÂÜåÁ†Å</p>
                <p style="margin-bottom: 0;"><strong>China mainland users:</strong> If you cannot access the
                    registration form below, please email your name and hospital/school name and address to <a
                        href="mailto:maas.team@varian.com">maas.team@varian.com</a>, and we will send you the
                    registration code by email as soon as possible.</p>
            </div>

            <div class="jotform-container">
                <div class="loading" id="loadingMessage">
                    Loading registration form...
                </div>
                <div id="jotform-embed"></div>
            </div>
        </div>

        <!-- Offline Registration Section -->
        <div id="offlineRegistration" class="offline-registration">
            <h2>Offline Registration</h2>
            <p>Your computer appears to be offline. You can still register using your mobile device!</p>

            <!-- China Access Message -->
            <div
                style="background-color: #e8f4fd; border: 1px solid #b6e0fe; border-radius: 4px; padding: 15px; margin-bottom: 20px; color: #0c5460;">
                <p style="margin-top: 0; font-weight: bold;">üá®üá≥ Registration for China Users / ‰∏≠ÂõΩÂ§ßÈôÜÁî®Êà∑Ê≥®ÂÜåËØ¥Êòé</p>
                <p><strong>‰∏≠ÂõΩÂ§ßÈôÜÁî®Êà∑:</strong> Â¶ÇÊûúÊÇ®Êó†Ê≥ïÂÆåÊàêÊ≥®ÂÜå, ËØ∑ÂèëÈÄÅÊÇ®ÁöÑÂßìÂêçÂíåÂåªÈô¢/Â≠¶Ê†°ÂêçÁß∞ÂèäÂú∞ÂùÄÂà∞ <a
                        href="mailto:maas.team@varian.com">maas.team@varian.com</a>, Êàë‰ª¨Â∞ÜÂ∞ΩÂø´‰ª•ÈÇÆ‰ª∂ÂΩ¢ÂºèÂèëÈÄÅÊÇ®ÁöÑÊ≥®ÂÜåÁ†Å</p>
                <p style="margin-bottom: 0;"><strong>China mainland users:</strong> If you cannot complete registration,
                    please email your name and hospital/school name and address to <a
                        href="mailto:maas.team@varian.com">maas.team@varian.com</a>, and we will send you the
                    registration code by email as soon as possible.</p>
            </div>

            <div class="qr-container">
                <h3>üì± Scan with your phone:</h3>
                <img src="resources/qrcode.bmp" alt="Registration QR Code for LatticeRT" />
                <div class="qr-link">
                    <p>If the QR code does not open, visit:</p>
                    <strong>https://varian-medicalaffairsappliedsolutions.github.io/LatticeRT/</strong>
                </div>
            </div>

            <div class="token-entry">
                <label for="registrationToken">After completing registration on your phone, enter the registration code
                    here:</label>
                <input type="text" id="registrationToken" maxlength="8" />
                <button onclick="validateToken()">Submit Code</button>
            </div>
        </div>

        <div class="footer">
                <p>By using this software, you agree to be bound by the terms of the <a href="VarianLUSLA.html"
                    target="_blank">Varian Limited Use Software License Agreement</a></p>
                <p><strong>Project:</strong> LatticeRT</p>
        </div>
    </div>

    <script>
        const STORAGE_KEYS = {
            registered: 'latticert_registered',
            timestamp: 'latticert_registration_timestamp',
            method: 'latticert_registration_method',
            token: 'latticert_registration_token'
        };
        const VALID_TOKEN = '91ECC2A2';

        function checkConnectionAndSetMode() {
            const statusDiv = document.getElementById('connectionStatus');
            const onlineSection = document.getElementById('onlineRegistration');
            const offlineSection = document.getElementById('offlineRegistration');

            if (!navigator.onLine) {
                setOfflineMode('üì± No network connection - Please use mobile registration');
                return;
            }

            statusDiv.className = 'connection-status';
            statusDiv.textContent = 'üîç Checking internet connectivity...';

            testInternetConnectivity()
                .then(function (hasInternet) {
                    if (hasInternet) {
                        setOnlineMode();
                    } else {
                        setOfflineMode('üì± Network detected but no internet access - Please use mobile registration');
                    }
                })
                .catch(function () {
                    setOfflineMode('üì± Cannot reach internet - Please use mobile registration');
                });

            function setOnlineMode() {
                statusDiv.className = 'connection-status online';
                statusDiv.textContent = '‚úÖ Internet connection verified - Using online registration';
                onlineSection.style.display = 'block';
                offlineSection.style.display = 'none';
                document.getElementById('retryConnection').style.display = 'none';
                initializeJotForm();
            }

            function setOfflineMode(message) {
                statusDiv.className = 'connection-status offline';
                statusDiv.textContent = message;
                onlineSection.style.display = 'none';
                offlineSection.style.display = 'block';
                document.getElementById('retryConnection').style.display = 'block';
            }
        }

        function testInternetConnectivity() {
            return new Promise(function (resolve) {
                const testEndpoints = [
                    'https://www.google.com/favicon.ico',
                    'https://jotform.com/favicon.ico',
                    'https://www.microsoft.com/favicon.ico'
                ];

                let testsCompleted = 0;
                let successCount = 0;
                const timeoutMs = 5000;

                function checkEndpoint(url) {
                    return new Promise(function (resolveTest) {
                        const img = new Image();
                        const timeout = setTimeout(function () {
                            resolveTest(false);
                        }, timeoutMs);

                        img.onload = function () {
                            clearTimeout(timeout);
                            resolveTest(true);
                        };

                        img.onerror = function () {
                            clearTimeout(timeout);
                            resolveTest(false);
                        };

                        img.src = url + '?t=' + Date.now();
                    });
                }

                testEndpoints.forEach(function (endpoint) {
                    checkEndpoint(endpoint).then(function (success) {
                        testsCompleted++;
                        if (success) successCount++;

                        if (testsCompleted === testEndpoints.length || successCount > 0) {
                            resolve(successCount > 0);
                        }
                    });
                });

                setTimeout(function () {
                    if (testsCompleted === 0) {
                        resolve(false);
                    }
                }, timeoutMs + 1000);
            });
        }

        function validateToken() {
            const token = document.getElementById('registrationToken').value.trim().toUpperCase();

            if (!token) {
                alert('Please enter a registration code.');
                return;
            }

            if (token === VALID_TOKEN) {
                localStorage.setItem(STORAGE_KEYS.registered, 'true');
                localStorage.setItem(STORAGE_KEYS.timestamp, new Date().toISOString());
                localStorage.setItem(STORAGE_KEYS.method, 'mobile_qr');
                localStorage.setItem(STORAGE_KEYS.token, token);

                showOfflineSuccessMessage();

                setTimeout(function () {
                    window.location.href = '../index.html';
                }, 2000);
            } else {
                alert('Invalid registration code. Please check your code and try again.');
            }
        }

        function showOfflineSuccessMessage() {
            const offlineSection = document.getElementById('offlineRegistration');
            offlineSection.innerHTML = `
                <div style="text-align: center; padding: 40px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                    <h3>‚úÖ Registration Successful!</h3>
                    <p>Thank you for registering. You will be redirected to the app shortly...</p>
                    <p><small>If you are not redirected automatically, <a href="../index.html" style="color: #155724; font-weight: bold;">click here</a> to continue.</small></p>
                </div>
            `;
        }

        function initializeJotForm() {
            const container = document.getElementById('jotform-embed');
            const loading = document.getElementById('loadingMessage');

            if (loading) loading.style.display = 'none';
            container.innerHTML = '';

            const iframe = document.createElement('iframe');
            iframe.id = 'JotFormIFrame-260505348471153';
            iframe.title = 'LatticeRT';
            iframe.allowTransparency = true;
            iframe.allow = 'geolocation; microphone; camera; fullscreen; payment';
            iframe.src = 'https://form.jotform.com/260505348471153';
            iframe.frameBorder = '0';
            iframe.style.minWidth = '100%';
            iframe.style.maxWidth = '100%';
            iframe.style.height = '539px';
            iframe.style.border = 'none';
            iframe.scrolling = 'no';
            container.appendChild(iframe);

            if (!window.jotformEmbedHandler) {
                const handlerScript = document.createElement('script');
                handlerScript.src = 'https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js';
                handlerScript.onload = function () {
                    if (window.jotformEmbedHandler) {
                        window.jotformEmbedHandler("iframe[id='JotFormIFrame-260505348471153']", 'https://form.jotform.com/');
                    }
                };
                document.body.appendChild(handlerScript);
            } else {
                window.jotformEmbedHandler("iframe[id='JotFormIFrame-260505348471153']", 'https://form.jotform.com/');
            }

            addManualContinueButton();
            hookJotFormSubmitDetection();
        }

        function hookJotFormSubmitDetection() {
            // Completion handler shared by auto-detect + manual button
            function completeRegistration(formMeta) {
                const token = prompt('Please enter your registration code to complete access:');
                if (!token) {
                    return;
                }

                const normalizedToken = token.trim().toUpperCase();
                if (normalizedToken !== VALID_TOKEN) {
                    alert('Invalid registration code. Access denied.');
                    return;
                }

                // Persist registration and lightweight submission metadata (cannot read cross-origin form fields)
                const submissionMeta = {
                    jotformId: '260505348471153',
                    submittedAt: new Date().toISOString(),
                    method: 'online_form',
                    detected: formMeta?.detected ?? 'manual',
                    userAgent: navigator.userAgent
                };

                localStorage.setItem(STORAGE_KEYS.registered, 'true');
                localStorage.setItem(STORAGE_KEYS.timestamp, submissionMeta.submittedAt);
                localStorage.setItem(STORAGE_KEYS.method, submissionMeta.method);
                localStorage.setItem(STORAGE_KEYS.token, normalizedToken);
                localStorage.setItem('latticert_registration_data', JSON.stringify(submissionMeta));

                const container = document.querySelector('.jotform-container');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                        <h3>‚úÖ Registration Successful!</h3>
                        <p>Thank you for registering. You will be redirected to the app shortly...</p>
                        <p><small>If you are not redirected automatically, <a href="../index.html" style="color: #155724; font-weight: bold;">click here</a> to continue.</small></p>
                    </div>
                `;

                setTimeout(function () {
                    window.location.href = '../index.html';
                }, 2000);
            }

            // JFCustomWidget submit hook (when available)
            if (window.JFCustomWidget) {
                window.JFCustomWidget.subscribe('submit', function () {
                    completeRegistration({ detected: 'jf_custom_widget' });
                });
            }

            // Capture submit events bubbling to window (backup)
            window.addEventListener('submit', function (e) {
                const action = e.target?.getAttribute && e.target.getAttribute('action');
                if (action && action.includes('jotform')) {
                    e.preventDefault();
                    completeRegistration({ detected: 'dom_submit' });
                }
            }, { capture: true });

            // Visibility change heuristic (iframe updates state post-submit)
            document.addEventListener('visibilitychange', function () {
                if (document.visibilityState !== 'visible') return;
                const formFrame = document.querySelector('iframe[src*="jotform"]');
                try {
                    const submitted = formFrame?.contentWindow?.document?.querySelector?.('form.jotform-form.submitted');
                    if (submitted) {
                        completeRegistration({ detected: 'visibility_change' });
                    }
                } catch (err) {
                    // Cross-origin access is expected to fail; ignore silently
                }
            });

            // Expose completion so manual button can reuse
            window.manualContinue = function () {
                completeRegistration({ detected: 'manual_continue' });
            };
        }

        function addManualContinueButton() {
            const container = document.querySelector('.jotform-container');
            const continueButton = document.createElement('div');
            continueButton.style.cssText = 'text-align: center; margin-top: 20px; padding: 15px; background-color: #f0f8ff; border: 1px solid #4dabf7; border-radius: 4px;';
            continueButton.innerHTML = `
                <p style="margin: 0 0 10px 0; color: #0c5460;"><strong>Completed the registration form?</strong></p>
                <button onclick="manualContinue()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                    Continue to App
                </button>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">Click after submitting the form above</p>
            `;
            container.appendChild(continueButton);
        }

        window.addEventListener('online', checkConnectionAndSetMode);
        window.addEventListener('offline', checkConnectionAndSetMode);

        document.addEventListener('DOMContentLoaded', function () {
            const tokenInput = document.getElementById('registrationToken');
            if (tokenInput) {
                tokenInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        validateToken();
                    }
                });
            }
        });

        window.addEventListener('load', function () {
            const isRegistered = localStorage.getItem(STORAGE_KEYS.registered);
            const token = localStorage.getItem(STORAGE_KEYS.token);
            if (isRegistered === 'true' && token === VALID_TOKEN) {
                window.location.href = '../index.html';
                return;
            }

            checkConnectionAndSetMode();
        });
    </script>
</body>
</html>
